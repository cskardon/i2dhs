---
title: "Introduction to Data Health Science Report"
author: "Charlotte Skardon (52533106)"
output: pdf_document
---


# TOODS

[] Summary
[] data acquisition,
[] cleaning,
[] transformation,
[] analysis,
[] visualisation

I want to investigate how the population prescribed drugs for anxiety, depression and psychosis vary geographically 
and how they have changed over a 10-year period at the Scottish national and local authority level.

1. What are the rates of prescriptions at a national level?
2. Are there differences in prescriptions between local authorities?
3. If they have changed, how have they have changed over the ten years at a national level?
4. If they have changed, how have they have changed over ten years between local authorities?

## Summary

* Who is your target audience, and what is the key message you aim to convey through your visualisations? 
* What data did you use to produce your visualisation? What are the limitations of these data? 
* What are the strengths and limitations of the analytical and visualisation approach you adopted?

## Libraries

```{r "Import Libraries"}
library("tidyverse")
library("viridis")
```

## Data Acquisition - Read in data files

Local and national data from the The Scottish Public Health Observatory (ScotPHO) Online Profiles Tool (2025) website. Available at: https://scotland.shinyapps.io/ScotPHO_profiles_tool/ (Accessed: 03 November 2025).

```{r "Read in the ScotPHO data"}
df_all_data <- read_csv('./data/ScotPHO_Population prescribed drugs for anxiety depression and psychosis_allyears_national_and_council_extract_2025-11-03.csv')
```



## Cleaning the data

```{r}
df_all_data |> 
    # Filtering by the 'total' quintile, as that's what we're interested in
    filter(quintile == 'Total') |> 
    # Getting the count (`n`) and the min/max values for the `value` and `year` columns to see 
    # if anything is out of the expected range
    # Also checking for missing (`na`) values in the columns
    summarise(
        n = n(), 
        minValue = min(value, na.rm=TRUE), maxValue = max(value, na.rm=TRUE), missingValue = sum(is.na(value)),
        minYear = min(year), maxYear = max(year), missingYear = sum(is.na(year))
    )
```

* There are no missing values
* `Year` is treated as a double, which is not correct

```{r}
df_all_data <- df_all_data |> 
    mutate(year = as.integer(year)) |> 
    filter(!is.na(value))
```


## Transforming the data

Creating two data frames, one for the national level data (where the `area_type` equals "Scotland") and at the local authority level (where the `area_type` equals "Council area"). 
In both the `value` used is filtered by the `quintile` column, pulling out only the "Total" values.
The minimum columns needed are also selected, at the national level that is only the `year` and `value`, at the local authority level, the `area_name` is also selected.

```{r}
national_data <- df_all_data |> 
        # Filtering by 'Total' values and only for Scotland as a whole
        filter(quintile == "Total" & area_type=="Scotland") |> 
        # Only selecting the 'year' and 'value' columns as this is all that is needed.
        select(c("year", "value")) |> 
        rename(percent_prescribed = value)

local_authority_data <- df_all_data |>
        # Filtering by 'Total' values and where the 'area_type' is the Council Area to get Local Authority data
        filter(quintile == "Total" & area_type=="Council area") |> 
        # Selecting the 'year', 'value' and 'area_name' for the local authorities
        select(c("year", "area_name", "value")) |> 
        rename(percent_prescribed = value)
```

## Analysing the data

Running some basic stats for the `national` and `local_authority` data sets.

```{r}
national_data |> 
    summarise(n = n(), mean = mean(percent_prescribed), sd = sd(percent_prescribed), iqr = IQR(percent_prescribed))
local_authority_data |> 
    summarise(n = n(), mean = mean(percent_prescribed), sd = sd(percent_prescribed), iqr = IQR(percent_prescribed))
```

The biggest differences are the standard deviation and inter-quartile range which shows there is a much wider range of values for the population prescribed drugs for anxiety, depression and psychosis on a local authority basis compared to national.


# CHARLOTTE - DO YOU WANT TO DO THIS?
```{r}
local_authority_data |> 
    filter(
        area_name %in% c("Aberdeen City", "Aberdeenshire", "Angus")) |> 
    kruskal.test(percent_prescribed~area_name)
```

## Visualisation

```{r}
national_data |> 
    ggplot(aes(x=year, y=percent_prescribed)) +
    geom_path() + 
    scale_colour_viridis_d() +
    theme_minimal()
```

```{r}
local_authority_data |> 
    ggplot(aes(x=year, y=percent_prescribed, color=area_name)) +
    geom_path() + 
    scale_colour_viridis_d()
```


# Extra

Greenspace data from: Greenspace Scotland (2018), Third State of Scotland's Greenspace Report. Available at: https://www.greenspacescotland.org.uk/statistics (Accessed: 23rd October 2025)

```{r}
df_green_space <- read_csv('./data/3rd-state-of-scotlands-greenspace-appendix-6-4.csv')
```


```{r}
# avg_time_in_hospital_by_deprivation_and_age_groups <- total_time_2020 |> 
#     mutate(age_bin = cut(age, breaks=c(0,10,20,30,40,50,60,70,80,90,100), include.lowest = TRUE)) |> 
#     group_by(deprivation, age_bin) |> 
#     summarise(avg_days_in_hospital = mean(total_time_days))
```


```{r "SIMD Definitions"}
# plot_names <- c('1' = '1 - Most Deprived',
#                 '2' = '2',
#                 '3' = '3',
#                 '4' = '4',
#                 '5' = '5 - Least Deprived')
```

```{r "Scatter graph of the deprivation"}
# avg_time_in_hospital_by_deprivation_and_age_groups |> 
    # mutate(deprivation = as.character(deprivation)) |> 
    # ggplot(
    #     aes(x = age_bin, y=avg_days_in_hospital, colour=deprivation)) + 
    # geom_point() +
    # scale_y_continuous(breaks = seq(0, 13, 1)) +
    # #scale_x_continuous(breaks = seq(0,100, 5)) + 
    # ggtitle("Length of stay in hospital by Age and by Deprivation") +
    # ylab("Average number of days in Hospital") +
    # xlab("Age Group") +
    # scale_colour_viridis_d() + 
    # theme_bw()
```


```{r}
# total_time_2020 |> 
#     group_by(deprivation, age) |> 
#     summarise(avg_days_in_hospital = mean(total_time_days)) |> 
#     mutate(deprivation = as.character(deprivation)) |> 
#     ggplot(aes(x = age, y=avg_days_in_hospital, colour=deprivation)) + 
#     geom_point() +
#     geom_smooth(se = FALSE) + 
#     scale_y_continuous(breaks = seq(0, 17, 1)) +
#     scale_x_continuous(breaks = seq(0,100, 5)) + 
#     labs(
#         title = "Length of stay in hospital by Age and by Deprivation",
#         x = "Age",
#         y = "Number of days in Hospital",
#         color = "SIMD Deprivation Level"
#     ) +
#     scale_color_viridis_d() +
#     theme(panel.background = element_rect(fill = 'darkgrey', color = 'black'),
#           panel.grid.major = element_line(color = 'lightgrey', linetype = 'dotted'),
#           panel.grid.minor = element_line(color = 'lightgrey', size = .2))
#     #theme_bw()
```