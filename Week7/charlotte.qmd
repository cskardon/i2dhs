```{r "Standard Knitting"}
knitr::opts_chunk$set(echo = TRUE)
```

# Load packages
```{r}
library("tidyverse")
```

# Read in Data
```{r}
data <- readr::read_csv('./Data/scotpho_data_extract.csv')
intermediate_zone_codes <- read_csv('./Data/iz2011_codes_and_labels_21042020.csv')
```


# Prepare Data
```{r prep}

#intermediate zone
iz_data <- data |> 
    filter(area_type == "Intermediate zone") |>
    select(area_name, area_code, year, measure)
```

```{r intermediatezone}
iz_info <- intermediate_zone_codes |>
    select(IntZone, HBName)
```

```{r "Join Datasets"}
admission_data <- left_join(iz_data, iz_info, join_by(area_code == IntZone))

admission_data <- admission_data |>
    mutate(HBName = gsub("NHS ", "", HBName)) |>
    rename(health_board = HBName, alcohol_admissions = measure)

write_csv(admission_data,  './Data/alcohol_related_admissions.csv')
```


```{r group}
grp <- admission_data |>
    group_by(health_board)

summarise(grp, n())
```

```{r "filter - grampian, fife, 2019"}
grampian_fife_data <- admission_data |>
    filter(
        year == 2019, 
        health_board %in% c("Grampian", "Fife")
    )
```

```{r histogram}
grampian_fife_data |> 
    ggplot(aes(x = alcohol_admissions)) +
    geom_histogram(bins = 15) +
    facet_wrap(~health_board) #different graph for each health board
```

Because the Grampian histogram looks quite out of 'normal', we can run the Quartile Plot...

```{r quantile_plot}
grampian_fife_data |>
    ggplot(aes(sample = alcohol_admissions)) +
    geom_qq() + 
    geom_qq_line(colour = "blue") + 
    facet_wrap(~health_board)
```

We can see that the Grampian data is not closely aligned to the blue 'normal' line - so we can't do parametric analysis with it


```{r quantile_plot}
grampian_fife_data |>
    ggplot(aes(x = health_board, y=alcohol_admissions)) +
    geom_boxplot() +
    geom_jitter(alpha = 0.4) + #Shows raw data points - with some variation on the x axis so they don't go over each other
    theme(legend.position = "none")
```

## Statistical comparison

Non-parametric test (because the data isn't normally distributed)

```{r "Wilcox test"}
#run (alcohol admissions FOREACH health board, using grampian_fife_data DATA)
wilcox.test(alcohol_admissions~health_board, data = grampian_fife_data)
```

For more than 2 health boards


```{r "Kruskal-Test"}
admission_data |> 
    filter(year == 2019,
        health_board %in% c("Grampian", "Fife", "Lothian")) %>% #interesting - using |> here didn't work
    kruskal.test(alcohol_admissions~health_board, data = .)
```


## Transform to normal

```{r log-transform}

grampian2019 <- admission_data |> 
    filter(year == 2019, health_board=="Grampian") |>
    mutate(alcohol_admissions_log = log(alcohol_admissions)) #new col added

grampian2019 |> 
    ggplot(aes(x = alcohol_admissions)) +
    geom_histogram(bins = 15) +
    ggtitle("Grampian alcohol-related hospital admissions in 2019")

grampian2019 |> 
    ggplot(aes(x = alcohol_admissions_log)) +
    geom_histogram(bins = 15) +
    ggtitle("Log of Grampian alcohol-related hospital admissions in 2019")

```

